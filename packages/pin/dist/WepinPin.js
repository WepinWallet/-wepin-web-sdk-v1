function e(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function n(e,n,t,i,r,a,o){try{var s=e[a](o),u=s.value}catch(e){t(e);return}s.done?n(u):Promise.resolve(u).then(i,r)}function t(e){return function(){var t=this,i=arguments;return new Promise(function(r,a){var o=e.apply(t,i);function s(e){n(o,r,a,s,u,"next",e)}function u(e){n(o,r,a,s,u,"throw",e)}s(void 0)})}}function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,n){return(a=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function o(e,n){var t,i,r,a,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(t)throw TypeError("Generator is already executing.");for(;o;)try{if(t=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,i=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(r=(r=o.trys).length>0&&r[r.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){o.label=a[1];break}if(6===a[0]&&o.label<r[1]){o.label=r[1],r=a;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(a);break}r[2]&&o.ops.pop(),o.trys.pop();continue}a=n.call(e,o)}catch(e){a=[6,e],i=0}finally{t=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}import{getModeByAppKey as s,getUrlsByMode as u,Platform as c,SafeEventEmitter as p,WebviewEventHandler as l,WEPIN_DEFAULT_CURRENCY as d,WEPIN_DEFAULT_LANG as f}from"@wepin/common";import{isErrorResponse as w,WepinFetch as h}from"@wepin/fetch-js";import{WepinLogin as v}from"@wepin/login-js";import{WepinModal as g}from"@wepin/modal-js";import y from"@wepin/storage-js";import{jwtDecode as b}from"jwt-decode";import m from"../package.json";export var WepinPin=function(n){!function(e,n){if("function"!=typeof n&&null!==n)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&a(e,n)}(I,n);var p,_,k=(p=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var n,t=r(I);return n=p?Reflect.construct(t,arguments,r(this).constructor):t.apply(this,arguments),n&&("object"==(n&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof n)?n:e(this)});function I(n){var t,r;return!function(e,n){if(!(e instanceof n))throw TypeError("Cannot call a class as a function")}(this,I),i(e(t=k.call(this)),"_login",void 0),i(e(t),"modal",new g),i(e(t),"webviewEventHandler",new l),i(e(t),"widget",void 0),i(e(t),"wepinStorage",new y),i(e(t),"_isInitialized",!1),i(e(t),"wepinAppAttributes",void 0),i(e(t),"_wepinLifeCycle",void 0),i(e(t),"_wepinFetch",void 0),i(e(t),"_userInfo",void 0),i(e(t),"appId",void 0),i(e(t),"appKey",void 0),t.appKey=n.appKey,t._login=null!==(r=n.wepinLogin)&&void 0!==r?r:new v({appId:"",appKey:t.appKey}),t.initEventHandler(),t}return _=[{key:"login",get:function(){return this._login}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{defaultLanguage:f},n=this;return t(function(){var t,i,r,a,s,u;return o(this,function(o){switch(o.label){case 0:if(n._isInitialized)throw Error("Wepin is already initialized!");return e&&(e.defaultLanguage=null!==(t=e.defaultLanguage)&&void 0!==t?t:f,e.defaultCurrency=null!==(i=e.defaultCurrency)&&void 0!==i?i:d,e.type=null!==(r=e.type)&&void 0!==r?r:"hide"),n.wepinAppAttributes=e,a=n.modal.domain,n._isInitialized=!1,n._wepinLifeCycle="initializing",n._wepinFetch=new h({appId:n.appId,appKey:n.appKey,domain:a,sdk:{version:m.version,type:"web-sdk"},storage:n.wepinStorage}),[4,n._wepinFetch.init()];case 1:return o.sent(),[4,n._wepinFetch.wepinApi.app.getAppInfo({platform:c.web,withNetwork:!1})];case 2:if(w(s=o.sent()))throw Error(s.message);return n.appId=n._wepinFetch.appId=s.appInfo.id,[4,n.wepinStorage.getLocalStorage(n.appId,"wepin:connectUser")];case 3:if((u=o.sent())&&n._wepinFetch.setToken(u),n.login.isInitialized())return[3,5];return[4,n.login.init(e.defaultLanguage)];case 4:o.sent(),o.label=5;case 5:return n._isInitialized=!0,[4,n.checkExpiredToken()];case 6:return o.sent()?n._wepinLifeCycle="initialized":n._wepinLifeCycle="login",[2]}})})()}},{key:"isInitialized",value:function(){return this._isInitialized}},{key:"checkExpiredToken",value:function(){var e=this;return t(function(){var n,t,i;return o(this,function(r){switch(r.label){case 0:return r.trys.push([0,8,,9]),[4,e.wepinStorage.getLocalStorage(e.appId,"wepin:connectUser")];case 1:if(!(n=r.sent()))return[2,!0];if(!(b(n.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(n)];case 2:return r.sent(),[4,e.wepinStorage.getLocalStorage(e.appId,"user_id")];case 3:return t=r.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:t})];case 4:if(w(i=r.sent()))return[2,!0];return n.accessToken=i.token,[4,e.wepinStorage.setLocalStorage(e.appId,"wepin:connectUser",n)];case 5:return r.sent(),[2,!1];case 6:return[2,!1];case 7:return[3,9];case 8:return r.sent(),[2,!0];case 9:return[2]}})})()}},{key:"finalize",value:function(){this._isInitialized=!1,this._wepinLifeCycle="initializing",this._userInfo=void 0,this._wepinFetch=void 0,this.wepinAppAttributes=void 0,this.login.finalize()}},{key:"initEventHandler",value:function(){var e,n,i=this;n="local_ak_dev_"===this.appKey.slice(0,13)?this.appKey.slice(6):this.appKey;var r=this;this.webviewEventHandler.addRequestHandler("ready_to_widget",(e=t(function(e){var t,i,a,s;return o(this,function(o){switch(o.label){case 0:return[4,r.wepinStorage.getAllLocalStorage(r.appId)];case 1:return a=null!==(i=o.sent())&&void 0!==i?i:{},s=r.webviewEventHandler.makeWepinResponseMessage(e,"SUCCESS",{appKey:n,appId:r.appId,domain:r.modal.domain,platform:c.web,version:m.version.includes("-alpha")?m.version.substring(0,m.version.indexOf("-")):m.version,type:"web-pin-module",localDate:a,attributes:r.wepinAppAttributes}),(null===(t=r.widget)||void 0===t?void 0:t.isOpen)&&r.widget.response(s),[2]}})}),function(n){return e.apply(this,arguments)})),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(e){i.widget&&(i.widget.close(),i.widget=void 0,i.modal.closeModal()),i.wepinStorage.getLocalStorage(i.appId,"user_info").then(function(n){var t;n?i.setUserInfo(n,!0):i.setUserInfo({status:"fail"},!0),(null===(t=i.widget)||void 0===t?void 0:t.isOpen)&&i.widget.response(i.webviewEventHandler.makeWepinResponseMessage(e,"SUCCESS",""))})}),this.webviewEventHandler.addRequestHandler("set_user_email",function(e){var n=i.webviewEventHandler.makeWepinResponseMessage(e,"SUCCESS",{});i.widget.isOpen&&i.widget.response(n)}),this.webviewEventHandler.addRequestHandler("set_local_storage",function(e){i.wepinStorage.setAllLocalStorage(i.appId,e.body.parameter.data).then(t(function(){var n,t;return o(this,function(r){switch(r.label){case 0:if(e.body.parameter.data&&e.body.parameter.data.user_info&&i.setUserInfo(e.body.parameter.data.user_info,!0),!(e.body.parameter.data&&e.body.parameter.data["wepin:connectUser"]))return[3,2];return[4,i.setToken(e.body.parameter.data["wepin:connectUser"])];case 1:r.sent(),r.label=2;case 2:return t=i.webviewEventHandler.makeWepinResponseMessage(e,"SUCCESS",""),(null===(n=i.widget)||void 0===n?void 0:n.isOpen)&&i.widget.response(t),[2]}})}))})}},{key:"setUserInfo",value:function(e,n){this._userInfo=e,e&&"success"===e.status?this._wepinLifeCycle="login":this._wepinLifeCycle="initialized",n&&this.emit("onUserInfoSet",e)}},{key:"setToken",value:function(e){var n=this;return t(function(){return o(this,function(t){switch(t.label){case 0:return[4,n._wepinFetch.setToken(e)];case 1:return t.sent(),[2]}})})()}},{key:"openAndRequestWepinWidget",value:function(e){var n,i=u(s(this.appKey)).wepinWebview,r={header:{id:Date.now()+Math.random(),request_from:"web",request_to:"wepin_widget"},body:e},a=this;return new Promise((n=t(function(n,t){return o(this,function(o){switch(o.label){case 0:return a.webviewEventHandler.addRequestHandler("get_sdk_request",function(i){var o,s=a.webviewEventHandler.makeWepinResponseMessage(i,"SUCCESS",r);(null===(o=a.widget)||void 0===o?void 0:o.isOpen)&&(a.webviewEventHandler.addResponseHandler(e.command,function(e){if("ERROR"===e.body.state){t(Error(e.body.data));return}n(e)},!0),a.widget.response(s))},!0),[4,a.modal.openModal(i,a.webviewEventHandler.getEventListenerFunction())];case 1:return a.widget=o.sent(),[2]}})}),function(e,t){return n.apply(this,arguments)}))}},{key:"checkLogin",value:function(){var e=this;return t(function(){return o(this,function(n){if(e.checkExpiredToken())throw Error("auth/login_required");return[2]})})()}},{key:"generateRegistrationPINBlock",value:function(){var e=this;return t(function(){return o(this,function(n){switch(n.label){case 0:return[4,e.checkLogin()];case 1:return n.sent(),[4,e.openAndRequestWepinWidget({command:"pin_register",parameter:{}})];case 2:return[2,n.sent().body.data]}})})()}},{key:"generateAuthPINBlock",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=this;return t(function(){return o(this,function(t){switch(t.label){case 0:return[4,n.checkLogin()];case 1:return t.sent(),[4,n.openAndRequestWepinWidget({command:"pin_auth",parameter:{count:e}})];case 2:return[2,t.sent().body.data]}})})()}},{key:"generateChangePINBlock",value:function(){var e=this;return t(function(){return o(this,function(n){switch(n.label){case 0:return[4,e.checkLogin()];case 1:return n.sent(),[4,e.openAndRequestWepinWidget({command:"pin_change",parameter:{}})];case 2:return[2,n.sent().body.data]}})})()}},{key:"generateAuthOTP",value:function(){var e=this;return t(function(){return o(this,function(n){switch(n.label){case 0:return[4,e.checkLogin()];case 1:return n.sent(),[4,e.openAndRequestWepinWidget({command:"pin_otp",parameter:{}})];case 2:return[2,n.sent().body.data]}})})()}}],function(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(I.prototype,_),I}(p);