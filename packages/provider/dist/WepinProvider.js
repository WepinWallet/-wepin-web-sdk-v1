function e(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function t(e,t,n,r,i,o,a){try{var u=e[o](a),p=u.value}catch(e){n(e);return}u.done?t(p):Promise.resolve(p).then(r,i)}function n(e){return function(){var n=this,r=arguments;return new Promise(function(i,o){var a=e.apply(n,r);function u(e){t(a,i,o,u,p,"next",e)}function p(e){t(a,i,o,u,p,"throw",e)}u(void 0)})}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}import{SafeEventEmitter as u,getModeByAppKey as p,getUrlsByMode as c}from"@wepin/common";import{WepinFetch as s,WepinPlatformType as l,isErrorResponse as f}from"@wepin/fetch-js";import{WepinModal as d}from"@wepin/modal-js";import w from"@wepin/storage-js";import{jwtDecode as v}from"jwt-decode";import h from"../package.json";import{PROVIDER_COOKIE_NAME as y}from"./const/cookieName";import g from"./ethereum/inPageProvider";import{getEventListener as _}from"./event/eventListener";import m from"./klaytn/inPageProvider";import{getNetworkByChainId as b}from"./utils/info";export var WepinProvider=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(I,t);var u,k,A=(u=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var t,n=i(I);return t=u?Reflect.construct(n,arguments,i(this).constructor):n.apply(this,arguments),t&&("object"==(t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)||"function"==typeof t)?t:e(this)});function I(t){var n,i=t.appId,o=t.appKey,a=t.modal,u=t.storage;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,I),r(e(n=A.call(this)),"version",void 0),r(e(n),"type",void 0),r(e(n),"wepinDomain",void 0),r(e(n),"wepinAppAttributes",void 0),r(e(n),"wepinAppId",void 0),r(e(n),"_wepinAppKey",void 0),r(e(n),"_wepinFetch",void 0),r(e(n),"_wepinModal",void 0),r(e(n),"_widget",void 0),r(e(n),"_wepinStorage",void 0),r(e(n),"_isInitialized",!1),r(e(n),"_url",void 0),r(e(n),"_EL",void 0),r(e(n),"queue",void 0),n.wepinAppId=i,n._wepinAppKey=o,n.version=h.version,n._wepinModal=null!=a?a:new d,n._wepinStorage=null!=u?u:new w,n.type=n._wepinStorage.platform,n.wepinDomain=n._wepinModal.domain,n}return k=[{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"_initQueue",value:function(){var e=this;this.queue=new Proxy([],{set:function(t,n,r){var i=Reflect.set(t,n,r);return e._widget&&e._widget.isOpen&&e._widget.request({header:{request_from:"web",request_to:"wepin_widget",id:new Date().getTime()},body:{command:"provider_request",parameter:""}}),i}})}},{key:"wepinModal",get:function(){return this._wepinModal}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"changeLanguage",value:function(e){this.wepinAppAttributes={defaultLanguage:e.language,defaultCurrency:e.currency}}},{key:"init",value:function(e){var t=this;return n(function(){var n;return a(this,function(r){switch(r.label){case 0:return t._wepinFetch=new s({appId:t.wepinAppId,appKey:t._wepinAppKey,domain:t.wepinDomain,sdk:{version:t.version,type:"".concat(t.type,"-provider")},storage:t._wepinStorage}),[4,t._wepinFetch.init()];case 1:return r.sent(),[4,t._wepinFetch.wepinApi.app.getAppInfo({platform:l[t.type],withNetwork:!1})];case 2:if(f(n=r.sent()))throw Error(n.message);return t.wepinAppId=t._wepinFetch.appId=n.appInfo.id,t._url=c(p(t._wepinAppKey)).wepinWebview,t._isInitialized=!0,t._EL=_(t,{appKey:t._wepinAppKey,appId:t.wepinAppId}),t.wepinAppAttributes=null!=e?e:{defaultCurrency:"USD",defaultLanguage:"en"},t._initQueue(),[2]}})})()}},{key:"isInitialized",value:function(){return this._isInitialized}},{key:"checkExpiredToken",value:function(){var e=this;return n(function(){var t,n,r;return a(this,function(i){switch(i.label){case 0:return i.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"wepin:connectUser")];case 1:if(!(t=i.sent()))return[2,!0];if(!(v(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return i.sent(),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"user_id")];case 3:return n=i.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:n})];case 4:if(f(r=i.sent()))return[2,!0];return t.accessToken=r.token,[4,e._wepinStorage.setLocalStorage(e.wepinAppId,"wepin:connectUser",t)];case 5:return i.sent(),[2,!1];case 6:return[2,!1];case 7:return[3,9];case 8:return i.sent(),[2,!0];case 9:return[2]}})})()}},{key:"getProvider",value:function(e){var t=this;return n(function(){var n,r,i,o,u,p,c,s,l,d,w,v;return a(this,function(a){switch(a.label){case 0:if(!1===t._isInitialized)throw Error("WepinProvider is not initialized yet. Please call init() method first.");if(!(null===(n=window.evmproviders)||void 0===n?void 0:n.Wepin))return[3,6];return[4,b(null===(r=window.evmproviders)||void 0===r?void 0:r.Wepin.chainId)];case 1:return u=a.sent(),p=null===(o=window.evmproviders)||void 0===o?void 0:null===(i=o.Wepin.selectedAddress)||void 0===i?void 0:i.toLowerCase(),[4,t.checkExpiredToken()];case 2:if(a.sent())return[3,6];return[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"wallet_id")];case 3:return c=a.sent(),[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"user_id")];case 4:return s=a.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({walletId:c,userId:s,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:2})];case 5:if(!f(l=a.sent())&&((null===(d=l.aa_accounts)||void 0===d?void 0:d.length)?l.accounts.concat(l.aa_accounts):null!==(w=l.accounts)&&void 0!==w?w:[]).filter(function(e){var t;return(null===(t=e.address)||void 0===t?void 0:t.toLowerCase())===p&&e.network.toLowerCase()===u}).length)return[2,window.evmproviders.Wepin];a.label=6;case 6:if(!((v=e.toLowerCase()).startsWith("evm")||"ethereum"===v))return[3,8];return[4,g.generate({network:v,wepinProvider:t})];case 7:case 9:return[2,a.sent()];case 8:if(!v.startsWith("klaytn"))return[3,10];return[4,m.generate({network:v,wepinProvider:t})];case 10:throw Error("Can not resolve network name: ".concat(e));case 11:return[2]}})})()}},{key:"openModal",value:function(){var e=this;return n(function(){return a(this,function(t){switch(t.label){case 0:return[4,e.wepinModal.openModal(e._url,e._EL)];case 1:return e._widget=t.sent(),[2]}})})()}},{key:"finalize",value:function(){var e=this;return n(function(){return a(this,function(t){switch(t.label){case 0:return[4,e._wepinStorage.clearLocalStorage(y+e.wepinAppId,"selectedAddress")];case 1:return t.sent(),e._initQueue(),[2]}})})()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(I.prototype,k),I}(u);