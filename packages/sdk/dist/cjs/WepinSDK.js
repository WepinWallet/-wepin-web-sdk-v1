"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"WepinSDK",{enumerable:!0,get:function(){return S}});var e=v(require("@metamask/safe-event-emitter")),t=require("@wepin/common"),n=require("@wepin/fetch-js"),i=require("@wepin/modal-js"),r=v(require("@wepin/sdk-js/package.json")),o=v(require("@wepin/storage-js")),s=require("jwt-decode"),a=require("./const/config.js"),u=require("./const/regExp.js"),c=require("./types/index.js"),l=require("./utils/accountBalance.js"),p=require("./utils/accounts.js"),d=v(require("./utils/log.js"));function f(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(e,t,n,i,r,o,s){try{var a=e[o](s),u=a.value}catch(e){n(e);return}a.done?t(u):Promise.resolve(u).then(i,r)}function g(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var o=e.apply(t,n);function s(e){w(o,i,r,s,a,"next",e)}function a(e){w(o,i,r,s,a,"throw",e)}s(void 0)})}}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function v(e){return e&&e.__esModule?e:{default:e}}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function E(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var S=function(e){"use strict";!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(A,e);var w,v,S=(w=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=h(A);return e=w?Reflect.construct(t,arguments,h(this).constructor):t.apply(this,arguments),e&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:f(this)});function A(e){var n,s=e.appId,a=e.appKey,u=e.wepinModal,c=e.wepinStorage;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,A),_(f(n=S.call(this)),"version",void 0),_(f(n),"type",void 0),_(f(n),"wepinAppAttributes",void 0),_(f(n),"wepinDomain",void 0),_(f(n),"specifiedEmail",void 0),_(f(n),"_wepinLifeCycle",void 0),_(f(n),"_isInitialized",void 0),_(f(n),"_modeByAppKey",void 0),_(f(n),"_wepinAppId",void 0),_(f(n),"_wepinAppKey",void 0),_(f(n),"_widget",void 0),_(f(n),"_wepinModal",void 0),_(f(n),"_wepinStorage",void 0),_(f(n),"_wepinFetch",void 0),_(f(n),"_accountInfo",void 0),_(f(n),"_detailAccount",void 0),_(f(n),"_userInfo",void 0),_(f(n),"webviewEventHandler",void 0),_(f(n),"wepinRequest",void 0),n.version=r.default.version,console.log("WepinWeb SDK v".concat(n.version)),n._isInitialized=!1,n.wepinLifeCycle="not_initialized",n._wepinAppId=s,n._wepinAppKey=a,n._wepinModal=u||new i.WepinModal,n._wepinStorage=c||new o.default,n.type=n._wepinStorage.platform,n._modeByAppKey=(0,t.getModeByAppKey)(a),n.webviewEventHandler=new t.WebviewEventHandler({checkValidEvent:function(e){return!!(n.wepinWidget.url.includes("/wepin-sdk-login")||n.wepinWidget.url.includes(e.origin))||e.origin===n.wepinWidget.url}}),n.initEventHandler(),n}return v=[{key:"initEventHandler",value:function(){var e,n,i=this;n="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(e){i.wepinStorage.getAllLocalStorage(i._wepinAppId).then(function(r){var o,s,a,u=Object.assign({},i.wepinAppAttributes),c=(null===(o=i.wepinAppAttributes.loginProviders)||void 0===o?void 0:o.length)||(null===(s=i.wepinAppAttributes.loginProviders)||void 0===s?void 0:s.length)===0?Array.from(i.wepinAppAttributes.loginProviders):void 0;u.loginProviders=c;var l=(0,t.makeWepinResponseMessage)(e,"SUCCESS",{appKey:n,appId:i._wepinAppId,domain:i.wepinDomain,platform:t.Platform[i.type],attributes:u,version:i.version.includes("-alpha")?i.version.substring(0,i.version.indexOf("-")):i.version,type:"".concat(i.type,"-sdk"),localDate:null!=r?r:{}});(null===(a=i.wepinWidget)||void 0===a?void 0:a.isOpen)&&i.wepinWidget.response(l)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){i.wepinWidget&&(i.wepinWidget.close(),i.wepinWidget=void 0)});var r=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(e=g(function(e){var n,i,o,s;return b(this,function(a){switch(a.label){case 0:return[4,r.wepinStorage.setAllLocalStorage(r._wepinAppId,e.body.parameter.data)];case 1:if(a.sent(),e.body.parameter.data&&e.body.parameter.data.user_info&&(i=e.body.parameter.data.user_info,o=e.body.parameter.data.user_status,i.userStatus=o,r.setUserInfo(i,!0)),!(e.body.parameter.data&&e.body.parameter.data["wepin:connectUser"]))return[3,3];return[4,r.setToken(e.body.parameter.data["wepin:connectUser"])];case 2:a.sent(),a.label=3;case 3:return s=(0,t.makeWepinResponseMessage)(e,"SUCCESS",""),(null===(n=r.wepinWidget)||void 0===n?void 0:n.isOpen)&&r.wepinWidget.response(s),[2]}})}),function(t){return e.apply(this,arguments)})),this.webviewEventHandler.addRequestHandler("set_user_email",function(e){var n,r=(0,t.makeWepinResponseMessage)(e,"SUCCESS",{email:i.specifiedEmail});(null===(n=i.wepinWidget)||void 0===n?void 0:n.isOpen)&&i.wepinWidget.response(r)}),this.webviewEventHandler.addRequestHandler("get_sdk_request",function(e){var n,r,o=(0,t.makeWepinResponseMessage)(e,"SUCCESS",null!==(r=(0,t.proxyToObject)(i.getSDKRequest()))&&void 0!==r?r:"No request");(null===(n=i.wepinWidget)||void 0===n?void 0:n.isOpen)&&i.wepinWidget.response(o)})}},{key:"wepinLifeCycle",get:function(){return this._wepinLifeCycle},set:function(e){if(e!==this._wepinLifeCycle){if(this._wepinLifeCycle=e,"login"===this._wepinLifeCycle||"login_before_register"===this._wepinLifeCycle){this.emit(c.WEPIN_SDK_EVENTS.WEPIN_LIFECYCLE_CHANGE,e,this._userInfo);return}this.emit(c.WEPIN_SDK_EVENTS.WEPIN_LIFECYCLE_CHANGE,e)}}},{key:"modeByAppKey",get:function(){if(void 0===this._modeByAppKey)throw Error("Wepin.modeByAppKey: wepin widget has to be initialized");return this._modeByAppKey}},{key:"toJSON",value:function(){return""}},{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{type:"hide",defaultLanguage:a.WEPIN_DEFAULT_LANG,defaultCurrency:a.WEPIN_DEFAULT_CURRENCY},t=this;return g(function(){var i,r,o,s,u;return b(this,function(c){switch(c.label){case 0:if(t._isInitialized)throw Error("Wepin is already initialized!");return e&&(e.defaultLanguage=null!==(i=e.defaultLanguage)&&void 0!==i?i:a.WEPIN_DEFAULT_LANG,e.defaultCurrency=null!==(r=e.defaultCurrency)&&void 0!==r?r:a.WEPIN_DEFAULT_CURRENCY,e.type=null!==(o=e.type)&&void 0!==o?o:"hide"),t.wepinAppAttributes=e,t.wepinDomain=t._wepinModal.domain,t._isInitialized=!1,t.wepinLifeCycle="initializing",t._wepinFetch=new n.WepinFetch({appId:t._wepinAppId,appKey:t._wepinAppKey,domain:t.wepinDomain,sdk:{version:t.version,type:"".concat(t.type,"-sdk")},storage:t._wepinStorage}),[4,t._wepinFetch.init()];case 1:return c.sent(),[4,t._wepinFetch.wepinApi.app.getAppInfo({platform:n.WepinPlatformType[t.type],withNetwork:!1})];case 2:if(s=c.sent(),(0,n.isErrorResponse)(s))throw Error(s.message);return t._wepinAppId=t._wepinFetch.appId=s.appInfo.id,[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 3:if(!(u=c.sent()))return[3,5];return[4,t._wepinFetch.setToken(u)];case 4:c.sent(),c.label=5;case 5:return t._isInitialized=!0,[4,t.checkExpiredToken()];case 6:return c.sent(),[2]}})})()}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"isInitialized",value:function(){return!!this._isInitialized}},{key:"changeLanguage",value:function(e){var t=e.currency,n=e.language;this.wepinAppAttributes.defaultCurrency=t,this.wepinAppAttributes.defaultLanguage=n}},{key:"openWidget",value:function(){var e=this;return g(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.getStatus()];case 1:if("login"!==t.sent())throw Error("Wepin.openWidget: You can open it only if you are logged in to the wepin.");return[4,e._open()];case 2:return t.sent(),[2]}})})()}},{key:"_open",value:function(e){var n=this;return g(function(){var i,r;return b(this,function(o){switch(o.label){case 0:if(o.trys.push([0,7,,8]),i=(0,t.getUrlsByMode)(n._modeByAppKey).wepinWebview,n._widget&&n._widget.isOpen)return[2];if((null==e?void 0:e.url)&&(i+=e.url),!((null==e?void 0:e.isHide)||"show"!==n.wepinAppAttributes.type&&(null==e?void 0:e.isInit)))return[3,2];return[4,n._wepinModal.openModal(i,n.webviewEventHandler.getEventListenerFunction(),{isHide:!0})];case 1:case 3:return n._widget=o.sent(),[3,6];case 2:if((null==e?void 0:e.type)!=="WINDOW")return[3,4];return[4,n._wepinModal.openAuthBrowser(i,n.webviewEventHandler.getEventListenerFunction())];case 4:return[4,n._wepinModal.openModal(i,n.webviewEventHandler.getEventListenerFunction())];case 5:n._widget=o.sent(),o.label=6;case 6:return[3,8];case 7:throw r=o.sent(),d.default.error(r),Error("Wepin.openWidget: Can't open wepin sdk widget");case 8:return[2]}})})()}},{key:"closeWidget",value:function(){if(!this._isInitialized)throw Error("Wepin.closeWidget: wepin sdk has to be initialized");if(this._widget)this._close();else throw Error("Wepin.closeWidget: wepin sdk widget is not exist")}},{key:"_close",value:function(){this.removeAllListeners("onUserInfoSet"),this.wepinRequest&&this.removeAllListeners(this.wepinRequest.header.id.toString()),this._widget&&(this._widget.close(),this._widget=void 0),this.specifiedEmail=void 0}},{key:"setToken",value:function(e){var t=this;return g(function(){return b(this,function(n){switch(n.label){case 0:return[4,t._wepinFetch.setToken(e)];case 1:return n.sent(),[2]}})})()}},{key:"checkExpiredToken",value:function(){var e=this;return g(function(){var t,i,r;return b(this,function(o){switch(o.label){case 0:return o.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wepin:connectUser")];case 1:if(!(t=o.sent()))return e.wepinLifeCycle="initialized",[2,!0];if(!((0,s.jwtDecode)(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return o.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return i=o.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:i})];case 4:if(r=o.sent(),(0,n.isErrorResponse)(r))return e.wepinLifeCycle="initialized",[2,!0];return t.accessToken=r.token,[4,e._wepinStorage.setLocalStorage(e._wepinAppId,"wepin:connectUser",t)];case 5:o.sent(),o.label=6;case 6:return[4,e.getWepinUserInfo()];case 7:return o.sent(),[2,!1];case 8:return o.sent(),[2,!0];case 9:return[2]}})})()}},{key:"loginWithUI",value:function(e){var t=this;return g(function(){var n,i;return b(this,function(r){switch(r.label){case 0:if(!t._isInitialized)throw Error("Wepin.loginWithUI: wepin sdk has to be initialized");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:return n=r.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 2:if(i=r.sent(),null==e?void 0:e.email){if(!u.emailRegExp.test(null==e?void 0:e.email))throw Error("Wepin.loginWithUI: The email does not match the correct format.");t.specifiedEmail=null==e?void 0:e.email}else t.specifiedEmail=void 0;if(t.wepinLifeCycle="before_login",!(n&&i))return[3,6];if(!(i&&(null==n?void 0:n.refreshToken)&&(null==e?void 0:e.email)&&(null==i?void 0:i.userInfo.email)!==(null==e?void 0:e.email)))return[3,4];return[4,t.logout()];case 3:r.sent(),r.label=4;case 4:if(!(null==n?void 0:n.refreshToken))return[3,6];return[4,t.checkExpiredToken()];case 5:if(!r.sent()&&i&&"success"===i.status)return[2,t._userInfo];r.label=6;case 6:return[4,t._open()];case 7:return r.sent(),[2,new Promise(function(e,n){t.once("onUserInfoSet",g(function(){var i;return b(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wepin:connectUser")];case 1:if(i=r.sent(),t._close(),t.specifiedEmail=void 0,!i)return n(Error("User canceled login")),[2];return[4,t._wepinFetch.setToken(i)];case 2:return r.sent(),[4,t.getWepinUserInfo()];case 3:return r.sent(),e(t._userInfo),[3,5];case 4:return n(Error(r.sent())),[3,5];case 5:return[2]}})}))})]}})})()}},{key:"getWepinUserInfo",value:function(e){var t=this;return g(function(){var n,i;return b(this,function(r){switch(r.label){case 0:return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_info")];case 1:return n=r.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_status")];case 2:if(i=r.sent(),!e)return[3,7];return n.walletId=e,[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 3:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_info",n)];case 4:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"wallet_id",e)];case 5:return r.sent(),[4,t._wepinStorage.setLocalStorage(t._wepinAppId,"user_status",{loginStatus:"complete"})];case 6:r.sent(),r.label=7;case 7:return t._userInfo=Object.assign(n,{userStatus:i}),n&&"success"===n.status?i&&"complete"===i.loginStatus?t.wepinLifeCycle="login":t.wepinLifeCycle="login_before_register":t.wepinLifeCycle="initialized",[2,t._userInfo]}})})()}},{key:"register",value:function(){var e=this;return g(function(){var t,i,r,o,s,a;return b(this,function(u){switch(u.label){case 0:if(!e._isInitialized)throw Error("Wepin.register: wepin sdk has to be initialized");return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_status")];case 1:return("registerRequired"===(t=u.sent()).loginStatus||"pinRequired"===t.loginStatus)&&e.wepinLifeCycle,[4,e.getStatus()];case 2:if("login_before_register"!==u.sent())throw Error("Wepin.register: The LifeCycle of wepin sdk has to be login_before_register");if("registerRequired"!==t.loginStatus&&"pinRequired"!==t.loginStatus)throw Error("Wepin.register: invalid login status");if(!("registerRequired"===t.loginStatus&&!t.pinRequired))return[3,8];return[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"user_id")];case 3:return i=u.sent(),[4,e._wepinStorage.getLocalStorage(e._wepinAppId,"wallet_id")];case 4:return r=u.sent(),[4,e._wepinFetch.wepinApi.app.register({appId:e._wepinAppId,userId:i,walletId:r,loginStatus:t.loginStatus})];case 5:if(o=u.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);return[4,e._wepinFetch.wepinApi.user.updateTermsAccepted({userId:i},{termsAccepted:{termsOfService:!0,privacyPolicy:!0}})];case 6:if(s=u.sent(),(0,n.isErrorResponse)(s)||!Object.values(s.termsAccepted).every(function(e){return!0===e}))throw Error("unknown/updateTermsAccepted");return[4,e.getWepinUserInfo(o.walletId)];case 7:return[2,u.sent()];case 8:return a=new Date().getTime(),e.wepinRequest={header:{request_from:"web",request_to:"wepin_widget",id:a},body:{command:"register_wepin",parameter:{loginStatus:t.loginStatus,pinRequired:t.pinRequired}}},[2,new Promise(function(t,n){var i;e.webviewEventHandler.addResponseHandler(a.toString(),(i=g(function(i){var r,o;return b(this,function(s){switch(s.label){case 0:if(e.wepinRequest=void 0,e._close(),"SUCCESS"!==i.body.state)return[3,2];return o=null===(r=i.body.data)||void 0===r?void 0:r.walletId,[4,e.getWepinUserInfo(o)];case 1:return s.sent(),t(e._userInfo),[3,3];case 2:i.body.data?n(Error("Wepin.register: ".concat(i.body.data))):n(Error("unknown/error")),s.label=3;case 3:return[2]}})}),function(e){return i.apply(this,arguments)}),!0),e._open({url:"/sdk-register"})})];case 9:return[2]}})})()}},{key:"logout",value:function(){var e=this;return g(function(){var t;return b(this,function(n){switch(n.label){case 0:return[4,e.getStatus()];case 1:if(t=n.sent(),!e._isInitialized)throw Error("Wepin.logout: wepin sdk has to be initialized");if("login"!==t&&"login_before_register"!==t)throw Error("Wepin.logout: Only if you're logged in to the wepin");return[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 2:return n.sent(),e.wepinLifeCycle="initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,[2]}})})()}},{key:"getAccounts",value:function(e){var t=this;return g(function(){var i,r,o;return b(this,function(s){switch(s.label){case 0:if(!t._isInitialized)throw Error("Wepin.getAccounts: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==s.sent())throw Error("Wepin.getAccounts: Only if you're logged in to the wepin");return[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"user_id")];case 2:return i=s.sent(),[4,t._wepinStorage.getLocalStorage(t._wepinAppId,"wallet_id")];case 3:return r=s.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({userId:i,walletId:r,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:"ja"===t.wepinAppAttributes.defaultLanguage?3:2})];case 4:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);if(t._detailAccount=(0,p.filterAccountList)(o,null==e?void 0:e.withEoa),t._accountInfo=(0,p.getAccountSDK)(t._detailAccount),(null==e?void 0:e.networks)!==void 0&&(null==e?void 0:e.networks.length)>0)return[2,t._accountInfo.filter(function(t){return(null==e?void 0:e.networks.findIndex(function(e){return e===t.network}))>=0})];return[2,t._accountInfo]}})})()}},{key:"setUserInfo",value:function(e,t){this._userInfo=e,e&&"success"===e.status?e.userStatus&&"complete"===e.userStatus.loginStatus?this.wepinLifeCycle="login":this.wepinLifeCycle="login_before_register":this.wepinLifeCycle="initialized",t&&this.emit("onUserInfoSet",e)}},{key:"getStatus",value:function(){var e=this;return g(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.checkExpiredToken()];case 1:return t.sent(),[2,e.wepinLifeCycle]}})})()}},{key:"getBalance",value:function(e){var t=this;return g(function(){var i,r,o,s,a,u,c,p,d,f,w,g,_,h,v;return b(this,function(y){switch(y.label){case 0:if(!t._isInitialized)throw Error("Wepin.getBalance: wepin sdk has to be initialized");return[4,t.getStatus()];case 1:if("login"!==y.sent())throw Error("Wepin.getBalance: Only if you're logged in to the wepin.");return i=!e||0===e.length,r=[],[4,t.getAccounts()];case 2:if(y.sent(),!i)return[3,11];o=!0,s=!1,a=void 0,y.label=3;case 3:y.trys.push([3,8,9,10]),u=function(){var i,o;return b(this,function(s){switch(s.label){case 0:if(i=p.value,!(e&&e.findIndex(function(e){return e.network===i.network&&e.address===i.address})>=0))return[3,2];return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:i.accountId})];case 1:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);r.push((0,l.filterAccountBalance)(t._detailAccount,i,o)),s.label=2;case 2:return[2]}})},c=t._detailAccount[Symbol.iterator](),y.label=4;case 4:if(o=(p=c.next()).done)return[3,7];return[5,E(u())];case 5:y.sent(),y.label=6;case 6:return o=!0,[3,4];case 7:return[3,10];case 8:return d=y.sent(),s=!0,a=d,[3,10];case 9:try{o||null==c.return||c.return()}finally{if(s)throw a}return[7];case 10:return[3,19];case 11:f=!0,w=!1,g=void 0,y.label=12;case 12:y.trys.push([12,17,18,19]),_=function(){var e,i,o;return b(this,function(s){switch(s.label){case 0:if(e=v.value,!(i=t._detailAccount.find(function(t){return e.network===t.network&&e.address===t.address})))throw Error("Wepin.getBalance: Account not found");return[4,t._wepinFetch.wepinApi.balance.getAccountBalance({accountId:i.accountId})];case 1:if(o=s.sent(),(0,n.isErrorResponse)(o))throw Error(o.message);return r.push((0,l.filterAccountBalance)(t._detailAccount,i,o)),[2]}})},h=e[Symbol.iterator](),y.label=13;case 13:if(f=(v=h.next()).done)return[3,16];return[5,E(_())];case 14:y.sent(),y.label=15;case 15:return f=!0,[3,13];case 16:return[3,19];case 17:return d=y.sent(),w=!0,g=d,[3,19];case 18:try{f||null==h.return||h.return()}finally{if(w)throw g}return[7];case 19:if(!r.length)throw Error("Wepin.getBalance: Account not found");return[2,r]}})})()}},{key:"getSDKRequest",value:function(){return this.wepinRequest}},{key:"send",value:function(e){var t=e.account,n=e.txData,i=this;return g(function(){var e;return b(this,function(r){switch(r.label){case 0:if(!i._isInitialized)throw Error("Wepin.send: wepin sdk has to be initialized");return[4,i.getStatus()];case 1:if("login"!==r.sent())throw Error("Wepin.send: Only if you're logged in to the wepin");return i.emit(c.WEPIN_SDK_EVENTS.SEND_IN_PROGRESS),[4,i.getAccounts()];case 2:if(r.sent(),!i._detailAccount.find(function(e){return t.network===e.network&&t.address===e.address}))throw i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,!1,"Account not found"),Error("Wepin.send: Account not found");return e=new Date().getTime(),i.wepinRequest={header:{request_from:"web",request_to:"wepin_widget",id:e},body:{command:"send_transaction_without_provider",parameter:{account:{address:t.address,network:t.network,contract:null==t?void 0:t.contract},from:t.address,to:null==n?void 0:n.toAddress,value:null==n?void 0:n.amount}}},[2,new Promise(function(t,n){i.webviewEventHandler.addResponseHandler(e.toString(),function(e){var r="SUCCESS"===e.body.state;if(i.wepinRequest=void 0,i._close(),r){var o=e.body.data;i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,o),t({txId:o})}else e.body.data?(i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,e.body.data),n(Error("Wepin.send: ".concat(e.body.data)))):(i.emit(c.WEPIN_SDK_EVENTS.SEND_COMPLETE,r,"unknown/error"),n(Error("unknown/error")))},!0),i._open({url:"/sdk-send"})})]}})})()}},{key:"finalize",value:function(){var e=this;return g(function(){return b(this,function(t){switch(t.label){case 0:return e._close(),[4,e._wepinStorage.clearAllLocalStorage(e._wepinAppId)];case 1:return t.sent(),e._isInitialized=!1,e.wepinLifeCycle="not_initialized",e._userInfo=void 0,e._accountInfo=void 0,e._detailAccount=void 0,e.specifiedEmail=void 0,[2]}})})()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(A.prototype,v),A}(e.default);