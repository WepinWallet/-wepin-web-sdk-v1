"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"WepinProvider",{enumerable:!0,get:function(){return f}});var e=require("@wepin/common"),n=require("@wepin/fetch-js"),t=require("@wepin/modal-js"),i=w(require("@wepin/provider-js/package.json")),r=w(require("@wepin/storage-js")),o=require("jwt-decode"),a=require("./const/cookieName.js"),s=w(require("./ethereum/inPageProvider.js")),u=w(require("./klaytn/inPageProvider.js")),p=require("./utils/info.js");function l(e,n,t,i,r,o,a){try{var s=e[o](a),u=s.value}catch(e){t(e);return}s.done?n(u):Promise.resolve(u).then(i,r)}function d(e){return function(){var n=this,t=arguments;return new Promise(function(i,r){var o=e.apply(n,t);function a(e){l(o,i,r,a,s,"next",e)}function s(e){l(o,i,r,a,s,"throw",e)}a(void 0)})}}function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function w(e){return e&&e.__esModule?e:{default:e}}function v(e,n){var t,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(t)throw TypeError("Generator is already executing.");for(;a;)try{if(t=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=n.call(e,a)}catch(e){o=[6,e],i=0}finally{t=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var f=function(){"use strict";var l;function w(n){var o=this,a=n.appId,s=n.appKey,u=n.modal,p=n.storage;!function(e,n){if(!(e instanceof n))throw TypeError("Cannot call a class as a function")}(this,w),c(this,"version",void 0),c(this,"type",void 0),c(this,"wepinDomain",void 0),c(this,"wepinAppAttributes",void 0),c(this,"wepinAppId",void 0),c(this,"_wepinAppKey",void 0),c(this,"_wepinFetch",void 0),c(this,"_wepinModal",void 0),c(this,"_widget",void 0),c(this,"_wepinStorage",void 0),c(this,"_isInitialized",!1),c(this,"_url",void 0),c(this,"webviewEventHandler",void 0),c(this,"queue",void 0),this.wepinAppId=a,this._wepinAppKey=s,this.version=i.default.version,this._wepinModal=null!=u?u:new t.WepinModal,this._wepinStorage=null!=p?p:new r.default,this.type=this._wepinStorage.platform,this.wepinDomain=this._wepinModal.domain,this.webviewEventHandler=new e.WebviewEventHandler({checkValidEvent:function(e){return!!(o.wepinWidget.url.includes("/wepin-sdk-login")||o.wepinWidget.url.includes(e.origin))||e.origin===o.wepinWidget.url}}),this.initEventHandler()}return l=[{key:"wepinStorage",get:function(){return this._wepinStorage}},{key:"initEventHandler",value:function(){var n,t,i=this;t="local_ak_dev_"===this._wepinAppKey.slice(0,13)?this._wepinAppKey.slice(6):this._wepinAppKey,this.webviewEventHandler.addRequestHandler("ready_to_widget",function(n){i.wepinStorage.getAllLocalStorage(i.wepinAppId).then(function(r){var o,a=Object.assign({},i.wepinAppAttributes),s=(0,e.makeWepinResponseMessage)(n,"SUCCESS",{appKey:t,appId:i.wepinAppId,domain:i.wepinDomain,platform:e.Platform[i.type],attributes:a,type:"".concat(i.type,"-provider"),version:i.version.includes("-alpha")?i.version.substring(0,i.version.indexOf("-")):i.version,localDate:null!=r?r:{}});(null===(o=i.wepinWidget)||void 0===o?void 0:o.isOpen)&&i.wepinWidget.response(s)})}),this.webviewEventHandler.addRequestHandler("close_wepin_widget",function(){i.wepinWidget.close()}),this.webviewEventHandler.addRequestHandler("dequeue_request",function(n){if(i.queue[0]){var t,r,o=(0,e.proxyToObject)(i.queue[0]);r=(0,e.makeWepinResponseMessage)(n,"SUCCESS",o)}else r=(0,e.makeWepinResponseMessage)(n,"ERROR",null);(null===(t=i.wepinWidget)||void 0===t?void 0:t.isOpen)&&i.wepinWidget.response(r)});var r=this;this.webviewEventHandler.addRequestHandler("set_local_storage",(n=d(function(n){var t,i;return v(this,function(o){switch(o.label){case 0:return[4,r.wepinStorage.setAllLocalStorage(r.wepinAppId,n.body.parameter.data)];case 1:return o.sent(),i=(0,e.makeWepinResponseMessage)(n,"SUCCESS",""),(null===(t=r.wepinWidget)||void 0===t?void 0:t.isOpen)&&r.wepinWidget.response(i),[2]}})}),function(e){return n.apply(this,arguments)})),this.webviewEventHandler.addGlobalHandler("pre_response",function(e){var n=i.queue.findIndex(function(n){return n.header.id===e.header.id});-1!==n&&i.queue.splice(n,1)})}},{key:"_initQueue",value:function(){var e=this;this.queue=new Proxy([],{set:function(n,t,i){var r=Reflect.set(n,t,i);return e._widget&&e._widget.isOpen&&e._widget.request({header:{request_from:"web",request_to:"wepin_widget",id:new Date().getTime()},body:{command:"provider_request",parameter:""}}),r}})}},{key:"wepinModal",get:function(){return this._wepinModal}},{key:"wepinWidget",get:function(){return this._widget},set:function(e){this._widget=e}},{key:"changeLanguage",value:function(e){this.wepinAppAttributes={defaultLanguage:e.language,defaultCurrency:e.currency}}},{key:"init",value:function(t){var i=this;return d(function(){var r;return v(this,function(o){switch(o.label){case 0:return i._wepinFetch=new n.WepinFetch({appId:i.wepinAppId,appKey:i._wepinAppKey,domain:i.wepinDomain,sdk:{version:i.version,type:"".concat(i.type,"-provider")},storage:i._wepinStorage}),[4,i._wepinFetch.init()];case 1:return o.sent(),[4,i._wepinFetch.wepinApi.app.getAppInfo({platform:n.WepinPlatformType[i.type],withNetwork:!1})];case 2:if(r=o.sent(),(0,n.isErrorResponse)(r))throw Error(r.message);return i.wepinAppId=i._wepinFetch.appId=r.appInfo.id,i._url=(0,e.getUrlsByMode)((0,e.getModeByAppKey)(i._wepinAppKey)).wepinWebview,i._isInitialized=!0,i.wepinAppAttributes=null!=t?t:{defaultCurrency:"USD",defaultLanguage:"en"},i._initQueue(),[2]}})})()}},{key:"isInitialized",value:function(){return this._isInitialized}},{key:"checkExpiredToken",value:function(){var e=this;return d(function(){var t,i,r;return v(this,function(a){switch(a.label){case 0:return a.trys.push([0,8,,9]),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"wepin:connectUser")];case 1:if(!(t=a.sent()))return[2,!0];if(!((0,o.jwtDecode)(t.accessToken).exp<Math.floor(Date.now()/1e3)+60))return[3,6];return[4,e._wepinFetch.setToken(t)];case 2:return a.sent(),[4,e._wepinStorage.getLocalStorage(e.wepinAppId,"user_id")];case 3:return i=a.sent(),[4,e._wepinFetch.wepinApi.user.refreshToken({userId:i})];case 4:if(r=a.sent(),(0,n.isErrorResponse)(r))return[2,!0];return t.accessToken=r.token,[4,e._wepinStorage.setLocalStorage(e.wepinAppId,"wepin:connectUser",t)];case 5:return a.sent(),[2,!1];case 6:return[2,!1];case 7:return[3,9];case 8:return a.sent(),[2,!0];case 9:return[2]}})})()}},{key:"getProvider",value:function(e){var t=this;return d(function(){var i,r,o,a,l,d,c,w,f,h,g,_,y;return v(this,function(v){switch(v.label){case 0:if(!1===t._isInitialized)throw Error("WepinProvider is not initialized yet. Please call init() method first.");if(!(null===(i=window.evmproviders)||void 0===i?void 0:i.Wepin))return[3,6];return l=null===(r=window.evmproviders)||void 0===r?void 0:r.Wepin.chainId,[4,(0,p.getNetworkByChainId)(l,!0)];case 1:return d=v.sent(),c=null===(a=window.evmproviders)||void 0===a?void 0:null===(o=a.Wepin.selectedAddress)||void 0===o?void 0:o.toLowerCase(),[4,t.checkExpiredToken()];case 2:if(v.sent())return[3,6];return[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"wallet_id")];case 3:return w=v.sent(),[4,t._wepinStorage.getLocalStorage(t.wepinAppId,"user_id")];case 4:return f=v.sent(),[4,t._wepinFetch.wepinApi.account.getAppAccountList({walletId:w,userId:f,localeId:"ko"===t.wepinAppAttributes.defaultLanguage?1:"ja"===t.wepinAppAttributes.defaultLanguage?3:2})];case 5:if(h=v.sent(),!(0,n.isErrorResponse)(h)&&((null===(g=h.aa_accounts)||void 0===g?void 0:g.length)?h.accounts.concat(h.aa_accounts):null!==(_=h.accounts)&&void 0!==_?_:[]).filter(function(e){var n;return(null===(n=e.address)||void 0===n?void 0:n.toLowerCase())===c&&e.network.toLowerCase()===d}).length)return[2,window.evmproviders.Wepin];v.label=6;case 6:if(!((y=e.toLowerCase()).startsWith("evm")||"ethereum"===y))return[3,8];return[4,s.default.generate({network:y,wepinProvider:t})];case 7:case 9:return[2,v.sent()];case 8:if(!y.startsWith("klaytn"))return[3,10];return[4,u.default.generate({network:y,wepinProvider:t})];case 10:throw Error("Can not resolve network name: ".concat(e));case 11:return[2]}})})()}},{key:"openModal",value:function(){var e=this;return d(function(){return v(this,function(n){switch(n.label){case 0:return[4,e.wepinModal.openModal(e._url,e.webviewEventHandler.getEventListenerFunction())];case 1:return e._widget=n.sent(),[2]}})})()}},{key:"finalize",value:function(){var e=this;return d(function(){return v(this,function(n){switch(n.label){case 0:return[4,e._wepinStorage.clearLocalStorage(a.PROVIDER_COOKIE_NAME+e.wepinAppId,"selectedAddress")];case 1:return n.sent(),e._initQueue(),[2]}})})()}}],function(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(w.prototype,l),w}();